# Firefly Collector

# What is this?

This is software to collect firefly packets from the LHC experiment data transfer hosts.

The purpose of these firefly packets is to communicate metadata for LHC scientific flows (e.g., type of transfer, experiment information). The fireflies are generated by end hosts.

# How to run the pipeline

The pipeline uses logstash UDP plugin to collect fireflies and write them to Opensearch and/or forward them to another collector.

To configure the pipeline run `cp conf/logstash/99-outputs.conf.example conf/logstash/99-outputs.conf`. Open the copied file and enter the parameters for your Opensearch server. If you are using SSL, you will need to place your CA certificate at `./conf/certificates/elastic.cer`. You can name this something else, just modify `99-outputs.conf` accordingly. 

To configure forwarding run `cp conf/logstash/99-firefly-fwd.conf.example conf/logstash/99-firefly-fwd.conf`. Open the copied file and change REPLACE_WFIREFLY_COLLECTOR to the hostname of the collector where fireflies should be forwarded.

Current configuration expects that collector runs on a dual stack machine. If that's not the case please update `conf/logstash/01-input.conf` host field to `0.0.0.0`.

With the Opensearch parameters configured, bring up the pipeline as follows:

```
sudo docker-compose up -d
```

By default logstash doesn't provide any verbose output. In order to debug, you need to run `cp conf/logstash/98-stdout.conf.debug conf/logstash/98-stdout.conf` and check the log with `docker -f logs logstash`.

You should see firefly records appear in Elasticsearch in the index `stardust_firefly-*`.
